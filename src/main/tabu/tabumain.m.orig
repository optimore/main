function status = tabumain(dataParameters, tabuParameters, logfileParameters, resultParameters)
%% Tabu main launching script
% This script is the over all launcher of the tabu search algorithm
%
<<<<<<< HEAD
%
=======
% TODO: 
% - Catch user force-quit and handle abort!
% - Set next phase in object instance, recreate model when phase is over
>>>>>>> master
%
% Created by: Victor Bergelin
% Date created:
% Version number 0.01
% 0.02: better structure and always run with status 1
% 0.03: OOD on instances to better handle multiple models and methods
%
%
% Linköping University, Linköping

status = 0;

% Add timing:
tic

try
<<<<<<< HEAD
    % 1. Setup logging *** DONE ***
    logfile = GetLog(logfileParameters);
    % logfile.parameters = logfileParameters;
    
    % 2. Read data and data parameters *** DONE ***
    data = GetData(dataParameters,logfile);
    data.parameters = dataParameters;
=======
    % 1. Setup logging:
    [status, logfile] = GetLog(logfileParameters);
    % 2. Read data and data parameters:
    [status, data] = GetData(dataParameters,logfile);
    tabuParameters.nrTasks = size(data.tasks,2);
>>>>>>> master
    
    % 3. Create result:
    [resultfile,runId] = CreateResult(resultParameters,logfile);
    
<<<<<<< HEAD
    % 4. Create result *** NEED IMPLEMENTATION ***
    resultfile = CreateResult(resultParameters,logfile);
    %result.parameters = resultParameters;
    
    % 5. Initial solution from model *** DONE ***
    [status,data] = InitialSolutionLauncher(model,data,logfile);
=======
    % 4. Create model and all instances:
    model = CreateModel(tabuParameters,resultfile,logfile);
        
    % 5. Initial solution from model
    [status,data] = InitialSolutionLauncher(model,data,logfile);   
>>>>>>> master
    
    
<<<<<<< HEAD
    % 7. Initial figure ***DONE***
    [fig1,fig2,figaxes1, figaxes2, figdata] = CreateFigures(data);
    DisplayIntervals(data,fig1,figaxes1,figdata);
    
    % 8. Perform tabu *** NEED IMPLEMENTATION ***
    conditionsAreNotMet = 1;
    iterations = 1;
    while conditionsAreNotMet
        try
            
            % 8.1 Get actions in list with costs associated:
            [status,actionList,costList] = GetActionList(model,data,tabuList,logfile);
            
            if DEBUGPLOT
                % 8.1.1 Print actionlist:
                figure(1);
                nlist = size(actionList,2);
                A = zeros(nlist,4);
                for i = 1:nlist
                    % actionList{i}.cost
                    A(i,1) = actionList{i}.cost.dep;
                    A(i,2) = actionList{i}.cost.over;
                    A(i,3) = actionList{i}.cost.bound;
                    A(i,4) = actionList{i}.cost.total;
                end
                
                plot(A)
                legend('dep','over','bound','total')
                pause(0.1)
            end
            
            % 8.2 Iteration logging
            fprintf(logfile, ['Iteration nr: ', num2str(iterations), '. ']);
            [status, data, tabuList] = DoAction(model,data,actionList,costList,tabuList,logfile);
            
            % 8.3 Display updated solution
            DisplayCurrentSolution(data,fig2,figaxes2,figdata);
            pause(0.1);
            
            % Evaluate current phase:
            % model = EvaluateNextStep(model,data);
            
            % Evaluate if condation are met:
            [status, conditionsAreNotMet] = AreConditionsMet(costList);
            
            iterations = iterations + 1;
            
            % End after 100 iterations
            nrIterations = 3000;
            if iterations > nrIterations
                disp(['Search ended after ',num2str(nrIterations), ...
                    ' iterations, no solution found.']);
                conditionsAreNotMet=0;
            end
=======
    % 6. Perform tabu 
    model.conditionsAreNotMet = 1;
    model.iterations = 1;
    while model.conditionsAreNotMet
        try
            
            % 6.1 Get and do tabu action: This method also logs result:
            data = model.instance{model.activePhase}. ...
                instance.GetAndPerformAction(data);
            
            
            % 6.2 Evaluate current phase and over all conditions:
            model = model.instance{model.activePhase}. ...
                instance.GetStoppingCriteria(model);
            
            % 6.3 Evaluate if condation are met: *** NEEDS FIX!! ***
            %model = model.instance{model.activePhase}. ...
             %   instance.AreConditionsMet();
            
>>>>>>> master
            
            % End after X iterations
            nrIterations = 100;
            if model.iterations > nrIterations
                model.conditionsAreNotMet=0;
            end            
        catch err
            fprintf(logfile,'\n\nFatal error in tabu search, quiting search\n')
            rethrow(err);
        end
        model.iterations = model.iterations + 1;
    end
    
    %Close figures
    close all;
    
    % . If all was successful, then set statuscode to 1
    status = 1;
    
    fprintf(logfile, ['Tabu search finished successfully.\nClosing log: ', ...
        datestr(now()), '\n---------------------------------------\n']);
    
    % Close files:
    fclose(resultfile);
    fclose(logfile);
    
catch err
    % In case of an error, set statuscode to -1
    status = -1;
    fprintf(logfile, getReport(err,'extended'));
    fprintf(logfile, ['\nClosing tabu-log due to fatal error: ', ...
        datestr(now()), '\n---------------------------------------\n']);
    fclose('all');
end

closetime = toc;


end

% DEBUGPLOT=0;
% if DEBUGPLOT % false
%                 % 6.1.1 Print actionlist:
%                 figure(1);
%                 nlist = size(actionList,2);
%                 A = zeros(nlist,4);
%                 for i = 1:nlist
%                     % actionList{i}.cost
%                     A(i,1) = actionList{i}.cost.dep;
%                     A(i,2) = actionList{i}.cost.over;
%                     A(i,3) = actionList{i}.cost.bound;
%                     A(i,4) = actionList{i}.cost.total;
%                 end
% 
%                 plot(A)
%                 legend('dep','over','bound','total')
%                 pause(0.1)
%             end
